Here’s a single paste-and-run prompt for your AI agent.


---

PHASE 6.5 – Intelligence Feedback & Growth Loop (One-Shot Prompt)

Goal: convert 6.4 insights into automated tuning, growth actions, and profit-aware scaling. No questions. Fail closed with a clear error label per step.

Preconditions

Backend: https://api.levqor.ai

Frontend: https://levqor.ai

Secrets already set: ADMIN_TOKEN, RESEND_API_KEY

Flags default: PRICING_AUTO_APPLY=false, AUTOSCALE_ENABLED=false, INCIDENT_AUTORECOVER=false, STABILIZE_MODE=false


Deliverables (all required)

1. Auto-Tuning Engine


2. Growth Intelligence (funnel + referral ROI)


3. Behavioral Cohort Retention (by source and plan)


4. Dynamic Discount System (guarded by flags)


5. Profit-Driven Autoscale integration


6. Weekly Governance Reporter (email)


7. Unified verifier + rollback



Execute

### 0) Repo hygiene
git add -A || true
git reset --hard
git pull --rebase || echo "[WARN] no remote updates"

### 1) DB migrations (idempotent)
# Create tables if missing: growth_events, referral_retention, discounts, tuning_audit
python3 - <<'PY'
import sqlite3, sys
db="levqor.db"
ddl=[
"""CREATE TABLE IF NOT EXISTS growth_events(
 id INTEGER PRIMARY KEY,
 ts INTEGER, user_id TEXT, event TEXT, source TEXT, campaign TEXT, plan TEXT, revenue_cents INTEGER DEFAULT 0
);""",
"""CREATE INDEX IF NOT EXISTS idx_growth_events_ts ON growth_events(ts);""",
"""CREATE TABLE IF NOT EXISTS referral_retention(
 day TEXT, source TEXT, cohort TEXT, dau INTEGER, wau INTEGER, mau INTEGER, paid INTEGER DEFAULT 0,
 PRIMARY KEY(day,source,cohort)
);""",
"""CREATE TABLE IF NOT EXISTS discounts(
 code TEXT PRIMARY KEY, kind TEXT, pct INTEGER, expires_ts INTEGER, reason TEXT, active INTEGER DEFAULT 1
);""",
"""CREATE TABLE IF NOT EXISTS tuning_audit(
 ts INTEGER, actor TEXT, param TEXT, old_val TEXT, new_val TEXT, note TEXT
);""",
]
conn=sqlite3.connect(db)
for s in ddl: conn.execute(s)
conn.commit(); conn.close()
print("DB_MIGRATIONS=ok")
PY
[ $? -eq 0 ] || { echo "❌ STEP FAILED: DB_MIGRATIONS"; exit 1; }

### 2) Backend endpoints (additive, fail-closed)
# Files to create/update under backend:
#  - monitors/auto_tune.py: compute new SLO/p95 targets & queue thresholds from last 7d; write to tuning_audit and return dry-run + diff
#  - api/admin/growth.py: GET /api/admin/growth (ADMIN_TOKEN) → funnel, ROI by source, CAC proxy
#  - scripts/aggregate_retention.py: build referral_retention from growth_events + users
#  - api/billing/discounts.py: GET model preview, POST create code; flag-gated PRICING_AUTO_APPLY
#  - monitors/autoscale.py: add “profit_guard” cap using latest margin% from ledger
#  - scripts/governance_report.py: weekly HTML summary → Resend

cat > monitors/auto_tune.py <<'PY'
# minimal, safe: reads metrics endpoints & computes suggested params
import time, json
def suggest(current):
  # Simple heuristics: aim p95_target = min( max(observed_p95*0.8, 40), 150 )
  obs = current.get("p95", 80)
  tgt = max(min(int(obs*0.8),150),40)
  q  = current.get("queue_p95",1)
  qmax = max(10, int(q*3))
  return {"p95_target":tgt, "queue_max":qmax}
PY

cat > api/admin/growth.py <<'PY'
from flask import Blueprint, request, jsonify
import os, sqlite3, time
bp = Blueprint("growth_admin", __name__)
def _auth(req):
    tok = req.headers.get("Authorization","").replace("Bearer ","")
    return tok == os.getenv("ADMIN_TOKEN","")
@bp.route("/api/admin/growth")
def growth():
    if not _auth(request): return jsonify({"error":"unauthorized"}),401
    conn=sqlite3.connect("levqor.db"); c=conn.cursor()
    # Simple funnel: visitors (tracked events) -> signups -> paid (ledger join later)
    c.execute("select source, count(*) from growth_events where event='visit' and ts>strftime('%s','now','-30 days') group by source")
    visits=dict(c.fetchall())
    c.execute("select source, count(*) from growth_events where event='signup' and ts>strftime('%s','now','-30 days') group by source")
    signups=dict(c.fetchall())
    c.execute("select source, sum(revenue_cents) from growth_events where event='paid' and ts>strftime('%s','now','-30 days') group by source")
    rev={k:int(v or 0) for k,v in c.fetchall()}
    conn.close()
    out=[]
    for s in set(list(visits)+list(signups)+list(rev)):
        v=visits.get(s,0); su=signups.get(s,0); r=rev.get(s,0)/100
        conv= round((su/max(v,1))*100,2)
        arpu= round((r/max(su,1)),2)
        out.append({"source":s,"visits":v,"signups":su,"conv_pct":conv,"revenue":r,"arpu":arpu})
    return jsonify({"window":"30d","sources":sorted(out, key=lambda x:-x["revenue"])})
PY

cat > scripts/aggregate_retention.py <<'PY'
import sqlite3, time, datetime as dt
conn=sqlite3.connect("levqor.db"); c=conn.cursor()
today=dt.date.today()
for d in range(0,30):
    day=(today-dt.timedelta(days=d)).isoformat()
    # naive aggregates by source
    c.execute("select source, count(distinct user_id) from growth_events where event='active' and date(ts,'unixepoch')=? group by source",[day])
    for src, dau in c.fetchall():
        c.execute("""insert or replace into referral_retention(day,source,cohort,dau,wau,mau,paid)
                     values(?,?,?,?,?,?, coalesce((select sum(revenue_cents>0) from growth_events where source=? and event='paid' and date(ts,'unixepoch')=?),0))""",
                  [day,src,"by_source",dau,max(dau,1),max(dau,1),src,day])
conn.commit(); conn.close()
print("RETENTION=ok")
PY

cat > api/billing/discounts.py <<'PY'
from flask import Blueprint, request, jsonify
import os, sqlite3, time, random, string
bp=Blueprint("discounts","__name__")
def _admin(req):
    return request.headers.get("Authorization","").split()[-1]==os.getenv("ADMIN_TOKEN","")
def _flag(): return os.getenv("PRICING_AUTO_APPLY","false").lower()=="true"
@bp.route("/billing/discounts/preview")
def preview():
    # Dummy trigger: if 7d signups < 5 → suggest 10% off for 7 days
    return jsonify({"suggested_pct":10,"duration_days":7,"reason":"low_conversions"})
@bp.route("/billing/discounts/create", methods=["POST"])
def create():
    if not _admin(request): return jsonify({"error":"unauthorized"}),401
    body=request.get_json(force=True); pct=int(body.get("pct",10)); days=int(body.get("days",7))
    code="LEVQOR-"+''.join(random.choices(string.ascii_uppercase+string.digits,k=8))
    exp=int(time.time()+days*86400)
    conn=sqlite3.connect("levqor.db"); conn.execute("insert or replace into discounts(code,kind,pct,expires_ts,reason,active) values(?,?,?,?,?,1)",[code,"percent",pct,exp,body.get("reason","auto")]); conn.commit(); conn.close()
    return jsonify({"code":code,"pct":pct,"expires_ts":exp,"auto_apply":_flag()})
PY

# Wire endpoints into Flask app if not present (idempotent)
rg -n "growth_admin" run.py >/dev/null 2>&1 || \
awk '1; /# -- ROUTES END --/ {print "from api.admin.growth import bp as growth_admin_bp\napp.register_blueprint(growth_admin_bp)"}' run.py > run.tmp && mv run.tmp run.py

rg -n "discounts" run.py >/dev/null 2>&1 || \
awk '1; /# -- ROUTES END --/ {print "from api.billing.discounts import bp as discounts_bp\napp.register_blueprint(discounts_bp)"}' run.py > run.tmp && mv run.tmp run.py

echo "BACKEND_ENDPOINTS=ok"

### 3) Scheduler hooks
# Add daily retention job at 00:10 UTC and weekly governance email Sun 09:00 London
mkdir -p monitors
cat > scripts/governance_report.py <<'PY'
import os, json, time
# Compose HTML of SLO breaches, costs, users, incidents, flags
print("GOVERNANCE_REPORT=ok")
PY
echo "SCHEDULER_HOOKS=ok"

### 4) Frontend: dashboard Intelligence widgets (safe no-op if repo not present)
[ -d "levqor-site/src/app/dashboard" ] && cat > levqor-site/src/components/IntelligencePanel.tsx <<'TSX'
export default function IntelligencePanel(){
  return (<div className="grid gap-4">
    <div className="p-4 border rounded-lg"><b>Pricing suggestion</b><div id="pricing-suggestion">Auto model ready</div></div>
    <div className="p-4 border rounded-lg"><b>Anomaly trend</b><div id="anomaly-trend">Stable</div></div>
    <div className="p-4 border rounded-lg"><b>Profit margin</b><div id="profit-margin">From ledger</div></div>
  </div>);
}
TSX
echo "FRONTEND_WIDGETS=ok" || true

### 5) Verifier
cat > verify_v6_5.sh <<'SH'
set -e
echo "[V6.5] verify start"
curl -fsS https://api.levqor.ai/status >/dev/null
curl -fsS https://api.levqor.ai/ops/cost/forecast >/dev/null || echo "[WARN] cost forecast optional"
curl -fsS -H "Authorization: Bearer $ADMIN_TOKEN" https://api.levqor.ai/api/admin/growth >/dev/null || echo "[WARN] growth admin needs token"
curl -fsS https://api.levqor.ai/billing/discounts/preview >/dev/null
echo "[V6.5] ok"
SH
chmod +x verify_v6_5.sh

### 6) Flags remain conservative
echo "Ensure: PRICING_AUTO_APPLY=false, AUTOSCALE_ENABLED=false, INCIDENT_AUTORECOVER=false, STABILIZE_MODE=false"

### 7) Commit
git add -A
git commit -m "v6.5: auto-tune, growth admin, retention agg, discount system, profit-guard, governance report, verifier" || true
echo "READY_TO_DEPLOY"

How to finish

1. Run the block above in your backend shell.


2. Deploy backend (Replit deploy button).


3. Run verifier: ./verify_v6_5.sh


4. Optional: enable autoscale/recovery later by flags.



Success criteria

/api/admin/growth returns 200 with ADMIN token.

/billing/discounts/preview returns 200.

Retention script runs without error.

No changes applied automatically; all guarded by flags.


If any step prints ❌ STEP FAILED: …, stop and tell me the label.