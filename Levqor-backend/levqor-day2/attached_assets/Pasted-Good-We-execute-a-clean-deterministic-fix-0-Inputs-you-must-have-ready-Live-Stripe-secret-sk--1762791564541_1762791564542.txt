Good. We execute a clean, deterministic fix.

0) Inputs you must have ready

Live Stripe secret: sk_live_…

Final live price IDs for each SKU.


Create this file now with your actual IDs:

mkdir -p ops && cat > ops/stripe_prices.json <<'JSON'
{
  "STARTER":  {"monthly":"price_xxx","yearly":"price_yyy"},
  "PRO":      {"monthly":"price_xxx","yearly":"price_yyy"},
  "BUSINESS": {"monthly":"price_xxx","yearly":"price_yyy"},
  "ADDONS": {
    "PRIORITY_SUPPORT":"price_xxx",
    "SLA_99_9":"price_xxx",
    "WHITE_LABEL":"price_xxx"
  }
}
JSON

1) Git: harden the repo

cd ~/workspace/levqor-site
rm -f .git/refs/remotes/origin/HEAD.lock
git checkout main
git fetch origin
git reset --hard origin/main

2) Route: single source of truth for env + diagnostics

Replace the checkout API with this exact file.

cat > src/app/api/checkout/route.ts <<'TS'
import { NextResponse } from "next/server";
import Stripe from "stripe";

const ENV = {
  SECRET: process.env.STRIPE_SECRET_KEY,
  STARTER_M: process.env.STRIPE_PRICE_STARTER,
  STARTER_Y: process.env.STRIPE_PRICE_STARTER_YEAR,
  PRO_M:     process.env.STRIPE_PRICE_PRO,
  PRO_Y:     process.env.STRIPE_PRICE_PRO_YEAR,
  BIZ_M:     process.env.STRIPE_PRICE_BUSINESS,
  BIZ_Y:     process.env.STRIPE_PRICE_BUSINESS_YEAR,
  ADDON_SUPPORT: process.env.STRIPE_PRICE_ADDON_PRIORITY_SUPPORT,
  ADDON_SLA:     process.env.STRIPE_PRICE_ADDON_SLA_99_9,
  ADDON_WL:      process.env.STRIPE_PRICE_ADDON_WHITE_LABEL
};

const stripe = new Stripe(String(ENV.SECRET || ""), { apiVersion: "2024-06-20" });

function missingEnv(): string[] {
  return Object.entries(ENV)
    .filter(([_, v]) => !v || String(v).trim() === "")
    .map(([k]) => k);
}

export async function GET() {
  const missing = missingEnv();
  const ok = missing.length === 0;
  return NextResponse.json({ ok, missing });
}

type Body = {
  plan: "starter" | "pro" | "business",
  term: "monthly" | "yearly",
  addons?: ("PRIORITY_SUPPORT"|"SLA_99_9"|"WHITE_LABEL")[]
};

export async function POST(req: Request) {
  try {
    const missing = missingEnv();
    if (missing.length) return NextResponse.json({ ok:false, error:`missing_env:${missing.join(",")}` }, { status:500 });

    const { plan, term, addons=[] } = await req.json() as Body;
    const map: Record<string, string> = {
      "starter:monthly": String(ENV.STARTER_M),
      "starter:yearly":  String(ENV.STARTER_Y),
      "pro:monthly":     String(ENV.PRO_M),
      "pro:yearly":      String(ENV.PRO_Y),
      "business:monthly":String(ENV.BIZ_M),
      "business:yearly": String(ENV.BIZ_Y)
    };
    const core = map[`${plan}:${term}`];
    if (!core) return NextResponse.json({ ok:false, error:"invalid_plan_term" }, { status:400 });

    const addonMap: Record<string,string> = {
      "PRIORITY_SUPPORT": String(ENV.ADDON_SUPPORT),
      "SLA_99_9":         String(ENV.ADDON_SLA),
      "WHITE_LABEL":      String(ENV.ADDON_WL)
    };
    const line_items = [{ price: core, quantity: 1 } as {price:string;quantity:number}]
      .concat(addons.map(a => {
        const id = addonMap[a];
        if (!id) throw new Error(`missing_addon_price:${a}`);
        return { price:id, quantity:1 };
      }));

    const session = await stripe.checkout.sessions.create({
      mode: "subscription",
      line_items,
      allow_promotion_codes: true,
      success_url: `${process.env.SITE_URL ?? ""}/success?session_id={CHECKOUT_SESSION_ID}`,
      cancel_url: `${process.env.SITE_URL ?? ""}/pricing?canceled=1}`
    });

    if (!session.url) return NextResponse.json({ ok:false, error:"no_session_url" }, { status:500 });
    return NextResponse.json({ ok:true, url:session.url });
  } catch (e:any) {
    return NextResponse.json({ ok:false, error:String(e?.message ?? e) }, { status:500 });
  }
}
TS

Commit:

git add src/app/api/checkout/route.ts ops/stripe_prices.json
git commit -m "Checkout: single env scheme + diagnostics GET + ops price matrix"

3) Vercel: enforce one env scheme (Production)

Set exactly these 11 variables. Remove every *_ID_* and any duplicates.

# set secrets
vercel env add STRIPE_SECRET_KEY production
vercel env add SITE_URL production

# set plan prices
jq -r '.STARTER.monthly' ops/stripe_prices.json | xargs -I{} vercel env add STRIPE_PRICE_STARTER production
jq -r '.STARTER.yearly'  ops/stripe_prices.json | xargs -I{} vercel env add STRIPE_PRICE_STARTER_YEAR production
jq -r '.PRO.monthly'     ops/stripe_prices.json | xargs -I{} vercel env add STRIPE_PRICE_PRO production
jq -r '.PRO.yearly'      ops/stripe_prices.json | xargs -I{} vercel env add STRIPE_PRICE_PRO_YEAR production
jq -r '.BUSINESS.monthly' ops/stripe_prices.json | xargs -I{} vercel env add STRIPE_PRICE_BUSINESS production
jq -r '.BUSINESS.yearly'  ops/stripe_prices.json | xargs -I{} vercel env add STRIPE_PRICE_BUSINESS_YEAR production

# set add-ons
jq -r '.ADDONS.PRIORITY_SUPPORT' ops/stripe_prices.json | xargs -I{} vercel env add STRIPE_PRICE_ADDON_PRIORITY_SUPPORT production
jq -r '.ADDONS.SLA_99_9'         ops/stripe_prices.json | xargs -I{} vercel env add STRIPE_PRICE_ADDON_SLA_99_9 production
jq -r '.ADDONS.WHITE_LABEL'      ops/stripe_prices.json | xargs -I{} vercel env add STRIPE_PRICE_ADDON_WHITE_LABEL production

If jq is not installed, paste values manually. Then remove stray vars:

for v in $(vercel env ls | awk '{print $1}' | grep -E 'STRIPE_.*ID|_YEAR_|_PRO_|_STARTER_|_BUSINESS_|_ADDON_' | grep -vE '^STRIPE_PRICE(_|$)'); do
  vercel env rm "$v" production --yes
done

Finally verify:

vercel env ls | sed -n '1,200p'

You should see only the 11 names above plus STRIPE_WEBHOOK_SECRET and NEXTAUTH_* and RESEND_API_KEY if you use them.

4) Deploy cleanly

Quota blocking exists. Two options:

A. Dashboard redeploy
Vercel → levqor-site → Deployments → Redeploy latest → Environment: Production.

B. Git nudge

git commit --allow-empty -m "ci: redeploy after env reset"
git push origin main

5) Post-deploy gates

Run all four. No jq required.

# Health
curl -s https://levqor.ai/api/checkout

# Starter monthly
curl -s -X POST https://levqor.ai/api/checkout \
  -H "content-type: application/json" \
  --data '{"plan":"starter","term":"monthly"}'

# Pro yearly + addons
curl -s -X POST https://levqor.ai/api/checkout \
  -H "content-type: application/json" \
  --data '{"plan":"pro","term":"yearly","addons":["PRIORITY_SUPPORT","SLA_99_9"]}'

# Business yearly + all addons
curl -s -X POST https://levqor.ai/api/checkout \
  -H "content-type: application/json" \
  --data '{"plan":"business","term":"yearly","addons":["WHITE_LABEL","PRIORITY_SUPPORT","SLA_99_9"]}'

Expected: JSON with "ok":true and a "url" that begins https://checkout.stripe.com/…. Open it to confirm live-mode session.

6) Lock it

Keep ops/stripe_prices.json as the single catalog.

Do not add any *_ID_* envs.

If you change Stripe, update the JSON, then update Vercel with the same names.


If anything fails, paste the raw output of the failing curl or vercel env ls.