set -e

echo "== 0) Preconditions =="
test -n "$STRIPE_SECRET_KEY" || { echo "Missing STRIPE_SECRET_KEY"; exit 1; }

# Helpers
mkprod() { stripe products create --name "$1" --active true --metadata project=levqor | jq -r .id; }
mkprice() { stripe prices create --product "$1" --currency gbp --unit-amount "$2" --recurring interval="$3" --active true | jq -r .id; }

echo "== 1) Archive old Levqor products/prices =="
# Archive active prices for products that look like Levqor*
for pid in $(stripe products list --limit 100 --active true | jq -r '.data[] | select(.name | test("Levqor"; "i")) | .id'); do
  for price in $(stripe prices list --product "$pid" --limit 100 --active true | jq -r '.data[].id'); do
    stripe prices update "$price" --active false > /dev/null || true
  done
  stripe products update "$pid" --active false > /dev/null || true
done

echo "== 2) Create new products =="
P_STARTER=$(mkprod "Levqor Starter")
P_PRO=$(mkprod "Levqor Pro")
P_BUS=$(mkprod "Levqor Business")
# optional add-ons
P_SEAT=$(mkprod "Levqor Add-on: Extra Seat")
P_SUPPORT=$(mkprod "Levqor Add-on: Priority Support")

echo "== 3) Create prices (GBP, recurring) =="
# Starter
PRICE_STARTER_MONTH=$(mkprice "$P_STARTER" 1900 month)
PRICE_STARTER_YEAR=$(mkprice "$P_STARTER" 19000 year)
# Pro
PRICE_PRO_MONTH=$(mkprice "$P_PRO" 4900 month)
PRICE_PRO_YEAR=$(mkprice "$P_PRO" 49000 year)
# Business
PRICE_BUS_MONTH=$(mkprice "$P_BUS" 14900 month)
PRICE_BUS_YEAR=$(mkprice "$P_BUS" 149000 year)
# Add-ons (optional; won’t be used by checkout yet)
PRICE_SEAT_MONTH=$(mkprice "$P_SEAT" 1000 month)
PRICE_SUPPORT_MONTH=$(mkprice "$P_SUPPORT" 9900 month)

echo "== 4) Emit Vercel env lines =="
cat <<ENV

# ===== Paste these into Vercel (Production) =====
# Core checkout (3 tiers × 2 terms)
STRIPE_PRICE_STARTER=$PRICE_STARTER_MONTH
STRIPE_PRICE_STARTER_YEAR=$PRICE_STARTER_YEAR
STRIPE_PRICE_PRO=$PRICE_PRO_MONTH
STRIPE_PRICE_PRO_YEAR=$PRICE_PRO_YEAR
STRIPE_PRICE_BUSINESS=$PRICE_BUS_MONTH
STRIPE_PRICE_BUSINESS_YEAR=$PRICE_BUS_YEAR

# Optional add-ons (not used by /api/checkout yet)
STRIPE_PRICE_ADDON_SEAT=$PRICE_SEAT_MONTH
STRIPE_PRICE_ADDON_SUPPORT=$PRICE_SUPPORT_MONTH
ENV

echo "== 5) Update Next.js checkout route to support Business =="
# Patch checkout handler (keeps static env refs; Next.js safe)
cat > levqor-site/src/app/api/checkout/route.ts <<'TS'
import { NextResponse } from 'next/server';
import Stripe from 'stripe';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY as string, { apiVersion: '2024-11-20' as any });

type Plan = 'starter' | 'pro' | 'business';
type Term = 'monthly' | 'yearly';

const MAP: Record<Plan, Record<Term, string | undefined>> = {
  starter: {
    monthly: process.env.STRIPE_PRICE_STARTER,
    yearly: process.env.STRIPE_PRICE_STARTER_YEAR,
  },
  pro: {
    monthly: process.env.STRIPE_PRICE_PRO,
    yearly: process.env.STRIPE_PRICE_PRO_YEAR,
  },
  business: {
    monthly: process.env.STRIPE_PRICE_BUSINESS,
    yearly: process.env.STRIPE_PRICE_BUSINESS_YEAR,
  },
};

async function createCheckout(priceId: string) {
  const session = await stripe.checkout.sessions.create({
    mode: 'subscription',
    line_items: [{ price: priceId, quantity: 1 }],
    success_url: `${process.env.SITE_URL}/dashboard?checkout=success`,
    cancel_url: `${process.env.SITE_URL}/pricing?checkout=cancelled`,
  });
  return session.url;
}

function pickPrice(planRaw: string | null, termRaw: string | null) {
  const plan = (planRaw || 'starter').toLowerCase() as Plan;
  const term = (termRaw || 'monthly').toLowerCase() as Term;
  if (!['starter','pro','business'].includes(plan)) return { error: 'invalid_plan' };
  if (!['monthly','yearly'].includes(term)) return { error: 'invalid_term' };
  const priceId = MAP[plan][term];
  if (!priceId) return { error: 'price_not_configured' };
  return { plan, term, priceId };
}

export async function GET(req: Request) {
  const { searchParams } = new URL(req.url);
  const plan = searchParams.get('plan');
  const term = searchParams.get('term');
  const pick = pickPrice(plan, term);
  if ('error' in pick) return NextResponse.json({ ok:false, error: pick.error }, { status: 400 });
  const url = await createCheckout(pick.priceId);
  return NextResponse.json({ ok:true, url, plan: pick.plan, term: pick.term });
}

export async function POST(req: Request) {
  const body = await req.json().catch(() => ({}));
  const pick = pickPrice(body?.plan ?? null, body?.term ?? null);
  if ('error' in pick) return NextResponse.json({ ok:false, error: pick.error }, { status: 400 });
  const url = await createCheckout(pick.priceId);
  return NextResponse.json({ ok:true, url, plan: pick.plan, term: pick.term });
}
TS

echo "== 6) Commit and push (triggers Vercel deploy) =="
git add levqor-site/src/app/api/checkout/route.ts
git commit -m "Pricing: add Business tier + clean Stripe IDs, static env mapping"
git push origin main || true

echo "== 7) Remind: add envs in Vercel UI =="
echo "Open Vercel → Project levqor.ai → Settings → Environment Variables → add the 8 lines printed above, redeploy."

echo "== 8) Simple verification after deploy =="
echo 'curl -s https://levqor.ai/api/checkout?plan=starter&term=monthly'
echo 'curl -s https://levqor.ai/api/checkout?plan=pro&term=yearly'
echo 'curl -s https://levqor.ai/api/checkout?plan=business&term=monthly'