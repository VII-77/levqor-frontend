
1) Do these two quick manual fixes (60s)

In Replit ‚Üí Secrets: set ALLOW_DIRTY=false.

In Notion ‚Üí üéôÔ∏è EchoPilot Job Log DB: add property Owner Email (type: Email).


If you want a helper for Notion AI, paste this there:

Add a new property to this database:
Name: "Owner Email"
Type: Email

2) Paste this into Replit AI (single prompt)

Open my Echopilotai Replit and apply all fixes below in one go.

GOAL: Remove timeouts, harden security, finish Phase 26 wiring.

CHANGES

A) Health & metrics (prevent blocking/timeouts)
- In run.py (or wherever /health is implemented), make /health 100% non-blocking:
  ‚Ä¢ Do NOT write to disk or call slow checks inline.
  ‚Ä¢ Return {"status":"ok"} immediately.
  ‚Ä¢ Spawn a background thread/task to append to logs/health.ndjson (best-effort, except if file missing then silently skip).
- In any metrics/heartbeat code (e.g., bot/metrics.py), ensure file writes use try/except, no flush/sync that could block requests.

B) File upload guardrails (customer portal)
- In /api/public/create-job:
  ‚Ä¢ Enforce max file size = 50 MB (reject with 413 style JSON).
  ‚Ä¢ Allow only .mp3 and .wav; reject others with clear JSON error.
  ‚Ä¢ If email provided in form, include it in created Notion Automation Queue entry (rich_text) and pass through to processor.

C) Job Log lookups (Owner Email)
- In /api/public/job-history/<email> and any status lookup, prefer the "Owner Email" property if present; fall back to rich_text field if not.
- In bot/processor.py, when logging a completed job:
  ‚Ä¢ If job_data includes owner email, write it to Job Log "Owner Email".
  ‚Ä¢ Keep existing fields intact.

D) Download links
- In /api/public/job-status/<cid>:
  ‚Ä¢ Always include: download_url (signed local URL if file in /tmp, or Drive link if available), drive_link if present.
  ‚Ä¢ If file missing, return ok:true with message:"pending-artifact".

E) Email notifications (remain test-safe)
- Add SMTP env hooks (do not send if creds missing):
  ‚Ä¢ SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS, SMTP_FROM
- Implement send_email(to, subject, html) that:
  ‚Ä¢ No-ops with ok:true if SMTP vars are absent; logs the attempt to logs/customer_email.log.
  ‚Ä¢ On success/failure, always log to logs/customer_email.log.
- In processor: after Payment Status becomes Paid and artifact exists, call send_email with templates/email_job_complete.html.

F) Security polish
- Rate-limit /api/public/send-email and /api/public/support to 5 req/min/IP (simple in-memory bucket).
- Ensure all public endpoints never print secrets; keep uniform JSON: {"ok":true/false,"data":{...},"error": "..."}.
- Keep Stripe in TEST mode only (no changes to live keys).

G) Tests (Replit AI should run)
- Hit /health ‚Üí must return fast JSON instantly.
- Upload a small mp3 (under 1 MB) ‚Üí create-job returns correlation_id.
- Poll /api/public/job-status/<cid> until Done; verify download_url present (or pending-artifact then available).
- Call /api/public/job-history/<email> ‚Üí returns last 5 jobs.
- Call /api/public/support ‚Üí returns ok:true and logs to Notion Support/Partners DB (or configured DB).
- If SMTP not set, send_email returns ok:true and logs to logs/customer_email.log.

FILES
- Update: run.py, bot/processor.py
- Create if missing: templates/email_job_complete.html
- Ensure logs folder contains/creates: customer_email.log

COMMIT MESSAGE
"Phase 26 hardening: non-blocking /health, upload guardrails, Owner Email wiring, safe email hooks, stable download URLs, rate limits."

That‚Äôs it.
When Replit AI finishes, test: upload ‚Üí process (~60s) ‚Üí payment (test card) ‚Üí download ‚Üí job history. If anything errors, paste the error + last 10 console lines and I‚Äôll triage.

