# === AI AGENT TASK: FIX ROUTING INCONSISTENCIES ===
# Goal: Align frontend <a href> links and Flask routes so all navigation works and no 404s remain.

set -euo pipefail

echo "== STEP 1: Scan for existing links =="
grep -RInE 'href=' marketing-site static | sed -n '1,100p' || true

echo
echo "== STEP 2: List all Flask routes =="
grep -RInE '@app\.route|register_blueprint' run.py | sed -n '1,100p' || true

echo
echo "== STEP 3: Auto-detect mismatched links =="
# Compare links and route patterns
python3 - <<'PY'
import re, subprocess
links = subprocess.getoutput("grep -RInE 'href=' marketing-site static").splitlines()
routes = subprocess.getoutput("grep -RInE '@app\\.route|register_blueprint' run.py").splitlines()
print("Frontend href targets:")
front = [re.search(r'href=["\']([^"\']+)', l) for l in links]
front = [m.group(1) for m in front if m]
print(sorted(set(front)))
print("\nRegistered Flask routes:")
rpaths = [re.search(r'@app\\.route\\(["\']([^"\']+)', l) for l in routes]
rpaths = [m.group(1) for m in rpaths if m]
print(sorted(set(rpaths)))
print("\nPotential mismatches:")
for p in sorted(set(front)):
    if p not in rpaths and not any(p.startswith(r) for r in rpaths):
        print("⚠️", p, "→ not registered")
PY

echo
echo "== STEP 4: Auto-fix known legacy links (safe patch) =="
applypatch <<'PATCH'
*** Begin Patch
*** Update File: run.py
@@
 app = Flask(__name__)
+
+# --- canonical URL redirects (legacy → canonical) ---
+REDIRECTS = {
+    "/login": "/auth/login",
+    "/dashboard": "/app",
+    "/account": "/auth/login",
+    "/signin": "/auth/login",
+    "/logout": "/auth/logout"
+}
+
+@app.before_request
+def _redirect_legacy_paths():
+    dst = REDIRECTS.get(request.path)
+    if dst:
+        return redirect(dst, code=301)
*** End Patch
PATCH

echo
echo "== STEP 5: Restart app cleanly =="
pkill -f "gunicorn .*run:app" || true
sleep 2
nohup gunicorn -w 1 -k gthread -t 120 --bind 0.0.0.0:5000 run:app > /tmp/gunicorn.out 2>&1 &
sleep 3

echo
echo "== STEP 6: Verify all key URLs =="
for p in / /pricing /auth/login /app /dashboard /login /workflow /help /support /health; do
  code=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:5000$p")
  printf "%-15s -> %s\n" "$p" "$code"
done

echo
echo "✅ ROUTE SYNC COMPLETE"