# ================================
# üöÄ ECHOPILOT: BOSS MODE RELAUNCH
# ================================
set -euo pipefail
echo "==========================================="
echo "üß† ECHOPILOT BOSS MODE ‚Äî FULL SYSTEM RELAUNCH"
echo "==========================================="

# --- 1Ô∏è‚É£ ENVIRONMENT & GUARDRAILS ---
echo "STEP 1 ‚Äî Enforcing cost and worker guardrails..."
cat > .env <<'ENV'
OPENAI_MODEL=gpt-4o-mini
MAX_COST_USD_JOB=0.75
MAX_TOKENS_JOB=300000
STRIPE_MODE=live
ENV
echo "‚úÖ Guardrails set (gpt-4o-mini, cost max $0.75/job)"

cat > Procfile <<'EOF'
web: gunicorn -w 1 -k gthread -t 120 --bind 0.0.0.0:5000 run:app
EOF
echo "‚úÖ Single-worker mode enforced (-w 1)"

# --- 2Ô∏è‚É£ AUTO-RUN VALIDATOR INSTALLATION ---
echo "STEP 2 ‚Äî Installing post-deploy auto-run validator..."
mkdir -p scripts logs
cat > scripts/post_deploy.sh <<'SH'
#!/bin/bash
set -e
python3 - <<'PY'
# EchoPilot E2E Finalizer (no Stripe)
import sys,os,json,time; sys.path.insert(0,'/home/runner/workspace')
from datetime import datetime; from bot.notion_api import NotionClientWrapper as W; from bot import config; from run import app
n=W()
print("="*80); print("E2E FINALIZER ‚Äî AUTO VALIDATION"); print("="*80)
props={"Job Name":{"title":[{"text":{"content":"E2E Auto-Validation"}}]},
"Task Type":{"select":{"name":"Processing"}},"Trigger":{"checkbox":True},
"Status":{"select":{"name":"New"}},"Payload Link":{"url":"https://filesamples.com/samples/audio/mp3/sample3.mp3"}}
n.create_page(config.AUTOMATION_QUEUE_DB_ID,props)
def val(p,n):
    if n not in p: return None
    t=p[n]['type']; d=p[n]
    return d['number'] if t=='number' else d['url'] if t=='url' else (d['select'] or {}).get('name') if t=='select' else (d['rich_text'][0]['text']['content'] if d['rich_text'] else None) if t=='rich_text' else (d['title'][0]['text']['content'] if d['title'] else None) if t=='title' else None
job=None
for delay in [5,10,20,30]:
    time.sleep(delay)
    rows=n.query_database(config.JOB_LOG_DB_ID)
    for r in rows[:10]:
        if val(r['properties'],'Gross USD') is not None:
            job={"qa":val(r['properties'],'QA') or val(r['properties'],'QA Score'),
                 "duration_sec":val(r['properties'],'Duration Sec'),
                 "gross_usd":val(r['properties'],'Gross USD'),
                 "profit_usd":val(r['properties'],'Profit USD'),
                 "margin_pct":val(r['properties'],'Margin %'),
                 "payment_status":val(r['properties'],'Payment Status')}
            break
    if job: break
gov="error"
try:
    with app.test_client() as c:
        gov="created" if c.post(f"/pulse?token={os.getenv('HEALTH_TOKEN','test')}").status_code==200 else "error"
except: pass
roi="not_configured"
try:
    cid=os.getenv('NOTION_COST_DASHBOARD_DB_ID')
    if cid:
        res=n.query_database(cid)
        if res: roi=(res[0]['properties'].get('ROI',{}).get('formula',{}) or {}).get('number','no_entries')
except: pass
result={"status":"PASS" if job else "PARTIAL",
"reason":"processed + finance tracked + pulse ok" if job else "Notion sync lag (retry)",
"qa":job and job["qa"],"duration_sec":job and job["duration_sec"],
"gross_usd":job and job["gross_usd"],"profit_usd":job and job["profit_usd"],
"margin_pct":job and job["margin_pct"],"payment_status":job and job["payment_status"],
"roi_30d":roi,"governance_pulse":gov}
print(json.dumps(result,indent=2))
with open("logs/e2e.json","a") as f: f.write(json.dumps(result)+"\n")
PY
SH
chmod +x scripts/post_deploy.sh
echo "‚úÖ Auto-run validator installed"

# --- 3Ô∏è‚É£ CRON-BASED CONTINUOUS VALIDATION ---
echo "STEP 3 ‚Äî Scheduling hourly health checks..."
(crontab -l 2>/dev/null; echo "@hourly bash scripts/post_deploy.sh >> logs/e2e_cron.log 2>&1") | crontab -
echo "‚úÖ Hourly validation cron added"

# --- 4Ô∏è‚É£ RUN INITIAL VALIDATION IMMEDIATELY ---
echo "STEP 4 ‚Äî Running immediate E2E validation..."
bash scripts/post_deploy.sh

# --- 5Ô∏è‚É£ HEALTH PULSE TEST ---
echo "STEP 5 ‚Äî Governance pulse health..."
python3 - <<'PY'
from run import app; import os
with app.test_client() as c:
    r=c.post(f"/pulse?token={os.getenv('HEALTH_TOKEN','test')}")
    print("Pulse status:",r.status_code)
PY

# --- 6Ô∏è‚É£ BACKLOG RESUME MARKER ---
echo "STEP 6 ‚Äî Tagging backlog state..."
echo "BOSS_MODE=ACTIVE" >> .env
echo "‚úÖ 28-issue backlog resumed and auto-validation enabled"
echo "==========================================="
echo "üéâ EchoPilot Boss Mode Relaunch Complete!"
echo "==========================================="