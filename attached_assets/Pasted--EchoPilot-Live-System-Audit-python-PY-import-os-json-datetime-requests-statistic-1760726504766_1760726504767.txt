# === EchoPilot Live System Audit ===
python - <<'PY'
import os, json, datetime, requests, statistics, pathlib
OUT={"timestamp":datetime.datetime.utcnow().isoformat()+"Z"}

def ok(x): return x in (True,"healthy","ok")

# 1) Core health
base=os.getenv("APP_BASE_URL","").rstrip("/")
try:
    OUT["app_health"]=requests.get(f"{base}/health",timeout=10).json() if base else {"status":"no-url"}
except Exception as e:
    OUT["app_health"]={"status":"error","error":str(e)}

# 2) Notion databases
H={"Authorization":f"Bearer {os.getenv('NOTION_API_KEY','')}","Notion-Version":"2022-06-28"}
def db_ok(dbid):
    try:
        r=requests.get(f"https://api.notion.com/v1/databases/{dbid}",headers=H,timeout=10)
        return r.status_code==200
    except: return False
OUT["notion_joblog_ok"]=db_ok(os.getenv("NOTION_DB_ID",""))
OUT["notion_clients_ok"]=db_ok(os.getenv("NOTION_CLIENT_DB_ID",""))
OUT["notion_status_ok"]=db_ok(os.getenv("NOTION_STATUS_DB_ID",""))

# 3) OpenAI ping
try:
    r=requests.post("https://api.openai.com/v1/chat/completions",
        headers={"Authorization":f"Bearer {os.getenv('OPENAI_API_KEY','')}","Content-Type":"application/json"},
        json={"model":"gpt-4o-mini","messages":[{"role":"system","content":"ok"},{"role":"user","content":"ping"}]},timeout=10)
    OUT["openai_ok"]=r.status_code==200
except Exception as e:
    OUT["openai_ok"]=False

# 4) Recent jobs summary
counts={}
try:
    q={"page_size":50,"filter":{"property":"Date","date":{"past_week":{}}}}
    r=requests.post(f"https://api.notion.com/v1/databases/{os.getenv('NOTION_DB_ID','')}/query",
                    headers={**H,"Content-Type":"application/json"},json=q,timeout=20).json()
    for p in r.get("results",[]): 
        st=p["properties"].get("Status",{}).get("select",{}).get("name","")
        counts[st]=counts.get(st,0)+1
    OUT["job_counts"]=counts
except Exception as e:
    OUT["job_counts_error"]=str(e)

# 5) Metrics tail
m={"total":0,"done":0,"avg_qc":None}
try:
    lines=pathlib.Path("metrics.csv").read_text().splitlines()[-100:]
    qc=[]
    for ln in lines:
        parts=ln.split(",",4)
        if len(parts)<5: continue
        m["total"]+=1
        try:q=float(parts[2]); qc.append(q)
        except:pass
        if "status=Done" in parts[4]: m["done"]+=1
    m["avg_qc"]=round(statistics.mean(qc),2) if qc else None
except Exception as e:
    m["error"]=str(e)
OUT["metrics"]=m

# 6) Payments config
OUT["payments"]={
    "stripe":bool(os.getenv("STRIPE_SECRET_KEY")),
    "paypal":bool(os.getenv("PAYPAL_CLIENT_ID") and os.getenv("PAYPAL_SECRET")),
    "webhook_secret":bool(os.getenv("STRIPE_WEBHOOK_SECRET")),
    "currency":os.getenv("PAYMENT_CURRENCY","USD")
}

# 7) Verdict
ver=[]
ver.append("App ✓" if ok(OUT["app_health"].get("status")) else "App ✗")
ver.append("OpenAI ✓" if OUT["openai_ok"] else "OpenAI ✗")
ver.append("Notion ✓" if (OUT["notion_joblog_ok"] and OUT["notion_status_ok"]) else "Notion ✗")
ver.append("Payments ✓" if (OUT["payments"]["stripe"] or OUT["payments"]["paypal"]) else "Payments ✗")
OUT["verdict"]=" | ".join(ver)

print(json.dumps(OUT,indent=2))
PY