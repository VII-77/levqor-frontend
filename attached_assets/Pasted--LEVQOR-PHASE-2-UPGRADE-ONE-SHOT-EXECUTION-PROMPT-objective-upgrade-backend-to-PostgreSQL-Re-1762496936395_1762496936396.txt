# LEVQOR PHASE-2 UPGRADE – ONE-SHOT EXECUTION PROMPT
# objective: upgrade backend to PostgreSQL + Redis queue + 20 connectors + React Flow builder
# fail-closed: if any step fails, stop and print FAILING STEP with reason
# cost-guard: abort if agent token use > $6
# est runtime: ≈ 15 minutes end-to-end

PLAN:
1.  Install dependencies:
        pip install psycopg2-binary redis rq sentry-sdk python-dotenv sqlalchemy alembic
2.  Migrate DB:
        •  create /db/migrate_v2.py → migrate SQLite → PostgreSQL
        •  envs: POSTGRES_URL, DATABASE_URL
        •  verify parity: counts of users, orgs, workflows, jobs identical
3.  Add Redis + RQ queue:
        •  new module queue/tasks.py, queue/worker.py
        •  env: REDIS_URL
        •  integrate into run.py – enqueue jobs async
        •  add /ops/queue_health returning {depth,fail_rate,retry_count}
4.  Upgrade connectors:
        •  duplicate existing connector code to connectors_v2/
        •  implement 15 new stubs following docs/CONNECTORS.md pattern
        •  update /actions/health to list 20 connectors
5.  Implement feature flags:
        •  create config/flags.json with {PG_ENABLED,NEW_QUEUE_ENABLED,BUILDER_ENABLED}
        •  all new paths gated by these flags
6.  Add Sentry + metrics:
        •  sentry_sdk.init(dsn=os.getenv("SENTRY_DSN"), traces_sample_rate=1.0)
        •  new /metrics endpoint exposing counters (jobs_run_total,queue_depth,error_rate)
7.  Add React Flow builder (frontend):
        •  create new page /builder using React Flow
        •  node types: trigger, action, condition, delay
        •  save DAGs via /api/workflows
8.  Enable multi-tenant auth:
        •  extend models.py: Organization, Membership, Role
        •  enforce org isolation in queries
9.  Update billing:
        •  /billing/usage computes per-org connector-runs
        •  /billing/limits exposes quota
10.  Observability:
        •  structured logging JSON → logs/queue.log, logs/api.log
        •  auto-rotation every 24 h
11.  Canary + rollback:
        •  script scripts/canary_check.sh runs 10 % traffic with flags on
        •  if p95 > 800 ms or error_rate > 2 %, rollback flags
12.  Verification:
        •  parity report users/orgs/workflows/jobs counts
        •  smoke connectors: scripts/smoke_connectors.sh
        •  /metrics → 200 OK, queue_depth ≥ 0
        •  /ops/queue_health → pass
13.  Commit + deploy:
        git add .
        git commit -m "Levqor Phase-2 upgrade"
        git push origin main
        vercel deploy --prod --yes --token=$VERCEL_TOKEN
14.  Cost guard:
        •  print "COST OK" if token usage < $6, else halt

VERIFY OUTPUT:
✅ “Phase-2 Upgrade Complete”
✅ “Parity check pass”
✅ “/metrics → 200”
✅ “No rollback triggered”