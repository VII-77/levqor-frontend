Use this as a single task for the Replit AI Agent.

Replit AI Agent — Force Rebuild, Sync, Restart, Verify, Publish (do NOT touch run.py)

Goal: ensure latest Next.js build is live, Flask serves it, health is green, and production shows the new stamp.

Do all steps exactly. Fail fast on errors.

1. Run in Shell



bash -lc '
set -euo pipefail
APP_DIR="marketing-site"; STATIC_DIR="static"; PORT="${PORT:-5000}"

# Preconditions
test -d "$APP_DIR/app" || { echo "x missing $APP_DIR/app"; exit 1; }
test -f run.py || { echo "x missing run.py"; exit 1; }

# Build + Export
pushd "$APP_DIR" >/dev/null
( npm ci || npm install ) >/dev/null
npx next build >/dev/null
npx next export >/dev/null
popd >/dev/null

# Sync to Flask static and stamp
mkdir -p "$STATIC_DIR"
rsync -a --delete "$APP_DIR/out/" "$STATIC_DIR/"
date -u +"BUILD_UTC=%Y-%m-%dT%H:%M:%SZ" | tee "$STATIC_DIR/.buildstamp"

# Restart gunicorn (do NOT modify run.py)
pkill -f "gunicorn .*run:app" || true
nohup gunicorn -w 1 -k gthread -t 120 --bind 0.0.0.0:"$PORT" run:app \
  > /tmp/gunicorn.out 2>&1 &

# Health wait
for i in $(seq 1 30); do
  code=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:$PORT/health" || true)
  [ "$code" = "200" ] && break; sleep 1
done
[ "$code" = "200" ] || { echo "x /health failed"; tail -n 80 /tmp/gunicorn.out; exit 1; }

# Content checks
chk(){ path="$1"; expect="$2"; body=$(curl -fsS "http://localhost:$PORT$path" || true)
echo "$body" | grep -qi "$expect" && echo "✓ $path ok" || { echo "x $path missing $expect"; exit 1; }; }
chk "/"            "EchoPilotAI"
chk "/pricing"     "<h1"
chk "/login"       "<h1>Login</h1>"
chk "/workflow"    "<h1>Workflow</h1>"
chk "/dashboard"   "Status"
chk "/help"        "<h1>Help Center</h1>"
echo -n "[stamp] "; cat "$STATIC_DIR/.buildstamp"
'

2. Fresh publish



Open Publishing → Shut down current deployment.

Then Publish (new snapshot).


3. Verify production



bash -lc '
ORIGIN="https://echopilotai.replit.app"
curl -fsS "$ORIGIN/health" && echo
curl -fsS "$ORIGIN/.buildstamp" || echo "stamp not exposed"
curl -fsS "$ORIGIN/login"    | grep -o "<h1>Login</h1>"      || echo "login missing"
curl -fsS "$ORIGIN/workflow" | grep -o "<h1>Workflow</h1>"   || echo "workflow missing"
curl -fsS "$ORIGIN/help"     | grep -o "<h1>Help Center</h1>"|| echo "help missing"
'

Report back:

Build stamp printed.

List of pages checked with ✓.

Any failure with the exact path and reason.