<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoPilot Ops Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .header p { opacity: 0.9; }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            padding: 30px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .log-container {
            padding: 0 30px 30px;
        }
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .log-header h2 { font-size: 1.2em; }
        .clear-btn {
            background: #e74c3c;
            padding: 8px 16px;
            font-size: 12px;
        }
        #log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .log-entry {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #333;
        }
        .log-entry:last-child { border-bottom: none; }
        .log-time {
            color: #858585;
            font-size: 11px;
        }
        .log-success { color: #4ec9b0; }
        .log-error { color: #f48771; }
        .log-info { color: #9cdcfe; }
        .log-warning { color: #dcdcaa; }
        .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .metrics-section {
            padding: 30px;
            background: #f8f9fa;
            border-top: 2px solid #e0e0e0;
        }
        .metrics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .metrics-header h2 { font-size: 1.4em; color: #333; }
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .chart-card h3 {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .chart-canvas {
            max-height: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ EchoPilot Ops Dashboard</h1>
            <p>Real-time system monitoring and control</p>
        </div>

        <div style="padding: 20px 30px 0;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Dashboard Access Key:</label>
            <input type="password" id="dashKey" placeholder="Enter DASHBOARD_KEY" 
                   style="width: 100%; padding: 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px; margin-bottom: 15px;">
        </div>

        <div class="grid">
            <button onclick="checkHealth()">‚úÖ Check Health</button>
            <button onclick="getSupervisorStatus()">üìä Supervisor Status</button>
            <button onclick="sendPulse()">üíì Send Pulse</button>
            <button onclick="createTestJob()">üéØ Create Test Job</button>
            <button onclick="getLatestJob()">üìã Refresh Jobs</button>
            <button onclick="flipToPaid()">üí∞ Flip to Paid</button>
            <button onclick="getMetricsSummary()">üìà Metrics Summary</button>
            <button onclick="runFullValidation()">üîç Run Full Validation</button>
        </div>

        <div class="button-grid">
            <h3 style="grid-column: 1/-1; margin: 15px 0 5px 0; font-size: 16px; color: #667eea;">‚öôÔ∏è Operations Tools (Phase 27 & 28)</h3>
            <button onclick="runSelfHeal()">üîß Self-Heal</button>
            <button onclick="getFinanceMetrics()">üí∞ Finance Metrics</button>
            <button onclick="triggerAlerts()">üö® Alert Check</button>
            <button onclick="runOptimizer()">üß† Run Optimizer</button>
        </div>

        <div class="button-grid">
            <h3 style="grid-column: 1/-1; margin: 15px 0 5px 0; font-size: 16px; color: #667eea;">üëî CEO Brief (Phase 29)</h3>
            <button onclick="ingestSignals()">üì• Ingest Now</button>
            <button onclick="generateBrief()">üìä Generate Brief</button>
            <button onclick="emailBrief()">üìß Email Brief</button>
            <button onclick="getLastBrief()">üìÑ Last Brief</button>
        </div>

        <div class="button-grid">
            <h3 style="grid-column: 1/-1; margin: 15px 0 5px 0; font-size: 16px; color: #667eea;">‚öôÔ∏è Automations (Scheduler)</h3>
            <button onclick="startAutomations()">‚ñ∂Ô∏è Start Scheduler</button>
            <button onclick="stopAutomations()">‚èπÔ∏è Stop Scheduler</button>
            <button onclick="checkAutomationsStatus()">üîç Check Status</button>
            <div style="grid-column: 1/-1; margin: 5px 0; display: flex; align-items: center; gap: 10px;">
                <label style="font-size: 14px; color: #667eea;">
                    <input type="checkbox" id="autoRefreshStatus" onchange="toggleAutoRefresh()" style="margin-right: 5px;">
                    Auto-refresh status (every 10s)
                </label>
                <span id="statusDisplay" style="font-size: 14px; color: #888;"></span>
            </div>
        </div>

        <!-- ==================== POST-DEPLOY CHECKLIST (Phase 30) ==================== -->
        <div class="button-grid" style="background: #1a1a2e; padding: 20px; border-radius: 12px; margin: 20px 0;">
            <h3 style="grid-column: 1/-1; margin: 0 0 15px 0; font-size: 16px; color: #667eea;">üßæ Post-Deploy Checklist</h3>
            <p style="grid-column: 1/-1; font-size: 13px; color: #aaa; margin-bottom: 10px;">Quick health verification after deployment.</p>
            <div id="checklist" style="grid-column: 1/-1; margin-bottom: 10px;">
                <label style="display: block; margin: 8px 0; font-size: 14px; color: #ddd;">
                    <input type="checkbox" id="chkScheduler" style="margin-right: 8px;">
                    ‚úÖ Scheduler running (PID active)
                </label>
                <label style="display: block; margin: 8px 0; font-size: 14px; color: #ddd;">
                    <input type="checkbox" id="chkTicks" style="margin-right: 8px;">
                    ‚úÖ Heartbeat ticks &lt; 60s apart
                </label>
                <label style="display: block; margin: 8px 0; font-size: 14px; color: #ddd;">
                    <input type="checkbox" id="chkBrief" style="margin-right: 8px;">
                    ‚úÖ Latest CEO Brief generated
                </label>
                <label style="display: block; margin: 8px 0; font-size: 14px; color: #ddd;">
                    <input type="checkbox" id="chkSelfheal" style="margin-right: 8px;">
                    ‚úÖ Self-Heal operational
                </label>
                <label style="display: block; margin: 8px 0; font-size: 14px; color: #ddd;">
                    <input type="checkbox" id="chkLogs" style="margin-right: 8px;">
                    ‚úÖ Logs available (scheduler.log)
                </label>
            </div>
            <button onclick="runChecklist()" style="grid-column: 1/-1; background: #9333ea; margin-bottom: 10px;">‚ñ∂ Run Checklist</button>
            <p id="checkResult" style="grid-column: 1/-1; font-size: 13px; color: #aaa; min-height: 20px;"></p>
            <div style="grid-column: 1/-1; margin-top: 10px; font-size: 13px;">
                <a href="/logs/scheduler.log" style="text-decoration: underline; color: #667eea; margin-right: 15px;">View scheduler.log</a>
                <a href="/logs/PHASE30_COMPLETE.txt" style="text-decoration: underline; color: #667eea;">Phase 30 summary</a>
            </div>
        </div>
        <!-- ==================== END POST-DEPLOY CHECKLIST ==================== -->

        <!-- ==================== HEALTH & COSTS (Phase 31) ==================== -->
        <div class="button-grid" style="background: linear-gradient(135deg, #1e3a5f 0%, #2d5a7b 100%); padding: 20px; border-radius: 12px; margin: 20px 0;">
            <h3 style="grid-column: 1/-1; margin: 0 0 15px 0; font-size: 16px; color: #fff;">üìä Health & Costs</h3>
            <div id="healthStatus" style="grid-column: 1/-1; margin-bottom: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span style="font-size: 14px; color: #ddd;">System Health:</span>
                    <span id="healthIndicator" style="font-size: 18px;">‚è≥</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 14px; color: #ddd;">Weekly Costs:</span>
                    <span id="costIndicator" style="font-size: 16px; color: #4ade80; font-weight: bold;">$0.00</span>
                </div>
            </div>
            <button onclick="runHealthProbe()" style="grid-column: 1/2; background: #10b981;">‚ü≥ Run Health Probe</button>
            <button onclick="getCosts()" style="grid-column: 2/-1; background: #3b82f6;">üí∞ Refresh Costs</button>
            <p id="healthResult" style="grid-column: 1/-1; font-size: 12px; color: #ccc; margin-top: 10px; min-height: 20px;"></p>
        </div>
        <!-- ==================== END HEALTH & COSTS ==================== -->

        <div class="metrics-section">
            <div class="metrics-header">
                <h2>üìä Metrics Visualization</h2>
                <button onclick="refreshCharts()">‚ü≥ Refresh Charts</button>
            </div>
            <div class="chart-grid">
                <div class="chart-card">
                    <h3>Jobs (7-day)</h3>
                    <canvas id="jobsChart" class="chart-canvas"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Avg QA (7-day)</h3>
                    <canvas id="qaChart" class="chart-canvas"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Revenue vs Cost (14-day)</h3>
                    <canvas id="revenueChart" class="chart-canvas"></canvas>
                </div>
            </div>
        </div>

        <div class="log-container">
            <div class="log-header">
                <h2>üìù Activity Log</h2>
                <button class="clear-btn" onclick="clearLog()">Clear</button>
            </div>
            <div id="log"></div>
        </div>
    </div>

    <script>
        let latestJobPageId = null;

        function getTimestamp() {
            return new Date().toLocaleTimeString();
        }

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            const time = document.createElement('div');
            time.className = 'log-time';
            time.textContent = getTimestamp();
            
            const content = document.createElement('div');
            content.className = `log-${type}`;
            content.textContent = message;
            
            entry.appendChild(time);
            entry.appendChild(content);
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('Log cleared', 'info');
        }

        async function apiCall(endpoint, method = 'GET', body = null) {
            const dashKey = document.getElementById('dashKey').value;
            if (!dashKey) {
                log('‚ö†Ô∏è Please enter your DASHBOARD_KEY first', 'warning');
                return null;
            }

            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = true);

            try {
                log(`${method} ${endpoint}...`, 'info');
                
                const options = {
                    method: method,
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Dash-Key': dashKey
                    }
                };
                
                if (body) {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(endpoint, options);
                const data = await response.json();

                if (response.ok) {
                    log(`‚úÖ SUCCESS (${response.status}):\n${JSON.stringify(data, null, 2)}`, 'success');
                    return data;
                } else {
                    log(`‚ùå ERROR (${response.status}):\n${JSON.stringify(data, null, 2)}`, 'error');
                    return null;
                }
            } catch (error) {
                log(`‚ùå FETCH ERROR:\n${error.message}`, 'error');
                return null;
            } finally {
                buttons.forEach(btn => btn.disabled = false);
            }
        }

        async function checkHealth() {
            await apiCall('/health', 'GET');
        }

        async function getSupervisorStatus() {
            await apiCall('/api/supervisor-status', 'GET');
        }

        async function sendPulse() {
            await apiCall('/api/pulse', 'POST');
        }

        async function createTestJob() {
            log('Creating test job with sample1.mp3...', 'warning');
            await apiCall('/api/create-test-job', 'POST');
        }

        async function getLatestJob() {
            log('Fetching latest job (handles Notion sync lag)...', 'warning');
            const data = await apiCall('/api/job-log-latest', 'GET');
            if (data && data.page_id) {
                latestJobPageId = data.page_id;
                log(`üìå Saved page_id: ${latestJobPageId}`, 'info');
            }
        }

        async function flipToPaid() {
            if (!latestJobPageId) {
                log('‚ö†Ô∏è No job page_id saved. Click "Refresh Jobs" first!', 'warning');
                return;
            }
            log(`Updating Payment Status to Paid for ${latestJobPageId}...`, 'warning');
            await apiCall('/api/flip-paid', 'POST', { page_id: latestJobPageId });
        }

        async function getMetricsSummary() {
            log('Fetching 7-day metrics from Governance DB...', 'info');
            const data = await apiCall('/api/metrics-summary', 'GET');
            if (data && data.ok) {
                const metrics = data.data;
                log(`\nüìä 7-DAY METRICS SUMMARY:\n` +
                    `   Jobs: ${metrics.jobs_7d}\n` +
                    `   Revenue: $${metrics.revenue_7d}\n` +
                    `   Avg QA: ${metrics.avg_qa_7d}%\n` +
                    (metrics.note ? `   Note: ${metrics.note}` : ''), 
                    'success');
            }
        }

        async function runFullValidation() {
            log('Running full E2E validation (dry run, no Stripe)...', 'warning');
            log('This may take 20-30 seconds...', 'info');
            const data = await apiCall('/api/release-captain', 'GET');
            if (data && data.ok) {
                const validation = data.data;
                log(`\nüîç VALIDATION RESULTS:\n` +
                    `   Status: ${validation.status || 'N/A'}\n` +
                    `   QA: ${validation.qa?.pass ? '‚úÖ PASS' : '‚ùå FAIL'}\n` +
                    `   Finance: ${validation.finance?.pass ? '‚úÖ PASS' : '‚ùå FAIL'}\n` +
                    `   Pulse: ${validation.pulse?.pass ? '‚úÖ PASS' : '‚ùå FAIL'}\n` +
                    (validation.note ? `   Note: ${validation.note}` : ''), 
                    validation.status === 'pass' ? 'success' : 'warning');
            }
        }

        async function runSelfHeal() {
            log('Running self-heal service...', 'warning');
            const data = await apiCall('/api/self-heal', 'POST');
            if (data && data.ok) {
                log(`\nüîß SELF-HEAL RESULTS:\n` +
                    `   Retried: ${data.retried_count} jobs\n` +
                    `   Unpaid eligible: ${data.eligible_unpaid.length}\n` +
                    `   Worker restart needed: ${data.worker_restart_suggested}\n` +
                    `   Notes: ${data.notes.join('; ')}`,
                    data.worker_restart_suggested ? 'warning' : 'success');
            }
        }

        async function getFinanceMetrics() {
            log('Fetching finance metrics...', 'info');
            const data = await apiCall('/api/finance-metrics', 'GET');
            if (data && data.ok) {
                const m = data.data;
                log(`\nüí∞ FINANCE METRICS (${data.source}):\n` +
                    `   Revenue (7d): $${m.revenue_7d} | (30d): $${m.revenue_30d}\n` +
                    `   Cost (7d): $${m.cost_7d} | (30d): $${m.cost_30d}\n` +
                    `   Profit (7d): $${m.profit_7d} | (30d): $${m.profit_30d}\n` +
                    `   ROI (30d): ${m.roi_30d}%\n` +
                    `   Jobs (7d): ${m.jobs_7d} | (30d): ${m.jobs_30d}\n` +
                    (data.warnings.length ? `   Warnings: ${data.warnings.join('; ')}` : ''),
                    'success');
            }
        }

        async function triggerAlerts() {
            log('Running alert check...', 'warning');
            const data = await apiCall('/api/alerts/trigger', 'POST');
            if (data && data.ok) {
                const alertType = data.triggered ? 'warning' : 'success';
                log(`\nüö® ALERT CHECK:\n` +
                    `   Triggered: ${data.triggered}\n` +
                    `   Target: ${data.target}\n` +
                    `   Reasons: ${data.reason.length > 0 ? data.reason.join('; ') : 'None'}\n` +
                    `   Timestamp: ${data.ts}`,
                    alertType);
            }
        }

        async function runOptimizer() {
            log('Running adaptive optimizer...', 'warning');
            const data = await apiCall('/api/optimizer/run', 'POST');
            if (data && data.ok) {
                const changed = data.old_rate !== data.new_rate;
                log(`\nüß† OPTIMIZER RESULTS:\n` +
                    `   Old Rate: $${data.old_rate}/min\n` +
                    `   New Rate: $${data.new_rate}/min\n` +
                    `   Avg QA: ${data.avg_qa}%\n` +
                    `   Margin: ${data.margin_pct}%\n` +
                    `   Reason: ${data.reason}`,
                    changed ? 'warning' : 'success');
            }
        }

        // Phase 29: CEO Brief functions
        async function ingestSignals() {
            log('Ingesting signals from all sources...', 'warning');
            const data = await apiCall('/api/exec/ingest', 'POST');
            if (data && data.ok) {
                const signals = data.data?.signals || {};
                const signalCount = Object.keys(signals).length;
                log(`\nüì• INGEST COMPLETE:\n` +
                    `   Signals collected: ${signalCount}\n` +
                    `   Saved to: ${data.saved_to}`,
                    'success');
            }
        }

        async function generateBrief() {
            log('Generating CEO Brief (ingest + analyze + brief)...', 'warning');
            log('This may take 10-20 seconds (GPT-4o-mini processing)...', 'info');
            const data = await apiCall('/api/exec/brief', 'POST');
            if (data && data.ok) {
                const brief = data.data;
                log(`\nüìä BRIEF GENERATED:\n` +
                    `   Headline: ${brief.headline}\n` +
                    `   Top Risks: ${brief.top_risks?.length || 0}\n` +
                    `   Actions (24h): ${brief.actions_next_24h?.length || 0}\n` +
                    `   Actions (7d): ${brief.actions_next_7d?.length || 0}\n` +
                    `   JSON: ${data.json_path}\n` +
                    `   HTML: ${data.html_path}`,
                    brief.top_risks?.length > 0 ? 'warning' : 'success');
            }
        }

        async function emailBrief() {
            log('Sending latest brief via email...', 'info');
            const data = await apiCall('/api/exec/email', 'POST');
            if (data && data.ok) {
                if (data.sent) {
                    log(`\nüìß EMAIL SENT:\n` +
                        `   To: ${data.to}\n` +
                        `   Status: Delivered`,
                        'success');
                } else {
                    log(`\nüìù EMAIL LOGGED:\n` +
                        `   SMTP not configured\n` +
                        `   Logged to: ${data.logged_to}`,
                        'warning');
                }
            }
        }

        async function getLastBrief() {
            log('Fetching latest CEO Brief...', 'info');
            const data = await apiCall('/api/exec/report-latest', 'GET');
            if (data && data.ok) {
                const brief = data.data;
                log(`\nüìÑ LATEST BRIEF:\n` +
                    `   Headline: ${brief.headline}\n` +
                    `   Summary:\n${brief.summary}\n` +
                    `   KPIs: Jobs=${brief.kpis?.jobs_7d}, QA=${brief.kpis?.avg_qa_7d}%, ROI=${brief.kpis?.roi_7d}x\n` +
                    `   Timestamp: ${brief.ts}`,
                    'success');
            }
        }

        // Automations Scheduler functions
        let autoRefreshInterval = null;

        async function startAutomations() {
            log('Starting background scheduler...', 'warning');
            const data = await apiCall('/api/automations/start', 'POST');
            if (data && data.ok) {
                log(`\n‚ñ∂Ô∏è SCHEDULER STARTED:\n` +
                    `   Status: ${data.status}\n` +
                    `   PID: ${data.pid || 'N/A'}\n` +
                    `   Schedule: CEO Brief (08:00 UTC), Report (09:00 UTC), Self-Heal (6h)`,
                    'success');
                // Refresh status after starting
                setTimeout(() => updateStatusDisplay(true), 2000);
            }
        }

        async function stopAutomations() {
            log('Stopping background scheduler...', 'warning');
            const data = await apiCall('/api/automations/stop', 'POST');
            if (data && data.ok) {
                log(`\n‚èπÔ∏è SCHEDULER STOPPED:\n` +
                    `   Status: ${data.status}`,
                    'success');
                // Refresh status after stopping
                setTimeout(() => updateStatusDisplay(true), 2000);
            }
        }

        async function checkAutomationsStatus() {
            log('Checking scheduler status...', 'info');
            await updateStatusDisplay(true);
        }

        async function updateStatusDisplay(showInLog = false) {
            const dashKey = document.getElementById('dashKey').value;
            if (!dashKey) return;

            try {
                const response = await fetch('/api/automations/status', {
                    method: 'GET',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Dash-Key': dashKey
                    }
                });
                const data = await response.json();

                if (data && data.ok) {
                    const status = data.data;
                    const statusDisplay = document.getElementById('statusDisplay');
                    
                    // Update status display
                    const statusText = status.running 
                        ? `‚úÖ Running (PID: ${status.pid || 'N/A'})` 
                        : '‚ùå Stopped';
                    statusDisplay.textContent = statusText;
                    statusDisplay.style.color = status.running ? '#27ae60' : '#e74c3c';

                    // Log if requested
                    if (showInLog) {
                        const statusType = status.running ? 'success' : 'warning';
                        log(`\nüîç SCHEDULER STATUS:\n` +
                            `   Running: ${status.running ? 'YES ‚úÖ' : 'NO ‚ùå'}\n` +
                            `   PID: ${status.pid || 'N/A'}\n` +
                            `   Last Activity: ${status.last_activity || 'N/A'}`,
                            statusType);
                    }
                }
            } catch (error) {
                // Silent fail for auto-refresh
                if (showInLog) {
                    log(`‚ùå Failed to get status: ${error.message}`, 'error');
                }
            }
        }

        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefreshStatus');
            
            if (checkbox.checked) {
                // Start auto-refresh every 10 seconds
                updateStatusDisplay(false); // Initial check
                autoRefreshInterval = setInterval(() => {
                    updateStatusDisplay(false);
                }, 10000);
                log('‚úÖ Auto-refresh enabled (10s interval)', 'success');
            } else {
                // Stop auto-refresh
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                document.getElementById('statusDisplay').textContent = '';
                log('‚èπÔ∏è Auto-refresh disabled', 'info');
            }
        }

        async function runChecklist() {
            const dashKey = document.getElementById('dashKey').value;
            const result = document.getElementById('checkResult');
            result.textContent = 'Running checks...';
            
            // Reset all checkboxes
            document.getElementById('chkScheduler').checked = false;
            document.getElementById('chkTicks').checked = false;
            document.getElementById('chkBrief').checked = false;
            document.getElementById('chkSelfheal').checked = false;
            document.getElementById('chkLogs').checked = false;

            try {
                // Check scheduler status
                const res = await fetch('/api/automations/status', {
                    headers: { 'X-Dash-Key': dashKey }
                });
                const data = await res.json();

                const running = data?.data?.running;
                const pid = data?.data?.pid;
                document.getElementById('chkScheduler').checked = running === true;

                // Check scheduler log
                const tickRes = await fetch('/logs/scheduler.log');
                const text = await tickRes.text();
                
                // Count ticks
                const tickCount = (text.match(/"event": "tick"/g) || []).length;
                document.getElementById('chkTicks').checked = tickCount > 0;

                // Check CEO Brief presence
                const briefOK = text.includes('exec_briefs') || text.includes('brief');
                document.getElementById('chkBrief').checked = briefOK;

                // Check Self-Heal indicator
                const selfhealOK = text.includes('self_heal');
                document.getElementById('chkSelfheal').checked = selfhealOK;

                // Check log presence
                document.getElementById('chkLogs').checked = text.length > 200;

                // Summary message
                if (running) {
                    result.textContent = `‚úÖ Scheduler PID ${pid} active. ${tickCount} ticks logged. System operational.`;
                    log(`üßæ Post-deploy checklist: PASSED (PID ${pid}, ${tickCount} ticks)`, 'success');
                } else {
                    result.textContent = '‚ö†Ô∏è Scheduler not active ‚Äî start it from "‚öôÔ∏è Automations (Scheduler)"';
                    log('üßæ Post-deploy checklist: FAILED - Scheduler not running', 'warning');
                }

            } catch (e) {
                result.textContent = '‚ùå Error: ' + e.message;
                log('üßæ Post-deploy checklist: ERROR - ' + e.message, 'error');
            }
        }

        async function runHealthProbe() {
            const dashKey = document.getElementById('dashKey').value;
            const result = document.getElementById('healthResult');
            const indicator = document.getElementById('healthIndicator');
            
            result.textContent = 'Running 5-point health probe...';
            indicator.textContent = '‚è≥';

            try {
                const res = await fetch('/api/system-health', {
                    headers: { 'X-Dash-Key': dashKey }
                });
                const data = await res.json();

                if (data.ok) {
                    indicator.textContent = '‚úÖ';
                    result.textContent = 'All systems healthy';
                    log('üìä Health probe: ALL CHECKS PASSED', 'success');
                } else {
                    indicator.textContent = '‚ö†Ô∏è';
                    const issues = data.issues?.join(', ') || 'Unknown issues';
                    result.textContent = `Issues detected: ${issues}`;
                    log(`üìä Health probe: ISSUES - ${issues}`, 'warning');
                }

                // Log component details
                if (data.components) {
                    log(`Components: ${JSON.stringify(data.components)}`, 'info');
                }

            } catch (e) {
                indicator.textContent = '‚ùå';
                result.textContent = '‚ùå Error: ' + e.message;
                log('üìä Health probe: ERROR - ' + e.message, 'error');
            }
        }

        async function getCosts() {
            const dashKey = document.getElementById('dashKey').value;
            const costIndicator = document.getElementById('costIndicator');
            const result = document.getElementById('healthResult');

            try {
                const res = await fetch('/api/runtime-costs', {
                    headers: { 'X-Dash-Key': dashKey }
                });
                const data = await res.json();

                if (data.ok && data.data) {
                    const total = data.data.total_usd || 0;
                    costIndicator.textContent = `$${total.toFixed(2)}`;
                    result.textContent = `Cost breakdown: ${JSON.stringify(data.data.breakdown)}`;
                    log(`üí∞ Runtime costs: $${total.toFixed(2)} (${data.data.period})`, 'success');
                } else {
                    costIndicator.textContent = '$?.??';
                    log('üí∞ Runtime costs: Failed to fetch', 'warning');
                }

            } catch (e) {
                costIndicator.textContent = '$?.??';
                log('üí∞ Runtime costs: ERROR - ' + e.message, 'error');
            }
        }

        // Chart.js instances
        let jobsChart, qaChart, revenueChart;

        function initCharts() {
            const jobsCtx = document.getElementById('jobsChart').getContext('2d');
            jobsChart = new Chart(jobsCtx, {
                type: 'bar',
                data: {
                    labels: ['Jobs'],
                    datasets: [{
                        label: '7-day Jobs',
                        data: [0],
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });

            const qaCtx = document.getElementById('qaChart').getContext('2d');
            qaChart = new Chart(qaCtx, {
                type: 'line',
                data: {
                    labels: ['QA Score'],
                    datasets: [{
                        label: '7-day Avg QA %',
                        data: [0],
                        borderColor: 'rgba(39, 174, 96, 1)',
                        backgroundColor: 'rgba(39, 174, 96, 0.2)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });

            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            revenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: ['7d', '14d'],
                    datasets: [
                        {
                            label: 'Revenue ($)',
                            data: [0, 0],
                            borderColor: 'rgba(102, 126, 234, 1)',
                            backgroundColor: 'rgba(102, 126, 234, 0.2)',
                            tension: 0.3
                        },
                        {
                            label: 'Cost ($)',
                            data: [0, 0],
                            borderColor: 'rgba(231, 76, 60, 1)',
                            backgroundColor: 'rgba(231, 76, 60, 0.2)',
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        async function refreshCharts() {
            const dashKey = document.getElementById('dashKey').value;
            if (!dashKey) {
                log('‚ö†Ô∏è Please enter your DASHBOARD_KEY first', 'warning');
                return;
            }

            log('Refreshing charts...', 'info');

            try {
                // Fetch metrics summary
                const metricsResp = await fetch('/api/metrics-summary', {
                    headers: { 'X-Dash-Key': dashKey }
                });
                const metricsData = await metricsResp.json();

                // Fetch finance metrics
                const financeResp = await fetch('/api/finance-metrics', {
                    headers: { 'X-Dash-Key': dashKey }
                });
                const financeData = await financeResp.json();

                if (metricsData.ok && financeData.ok) {
                    const m = metricsData.data;
                    const f = financeData.data;

                    // Update Jobs chart
                    jobsChart.data.datasets[0].data = [f.jobs_7d || m.jobs_7d || 0];
                    jobsChart.update();

                    // Update QA chart
                    qaChart.data.datasets[0].data = [m.avg_qa_7d || 0];
                    qaChart.update();

                    // Update Revenue vs Cost chart (7d vs 14d approximation)
                    revenueChart.data.datasets[0].data = [f.revenue_7d, f.revenue_30d / 2];
                    revenueChart.data.datasets[1].data = [f.cost_7d, f.cost_30d / 2];
                    revenueChart.update();

                    log('‚úÖ Charts refreshed successfully', 'success');
                } else {
                    log('‚ö†Ô∏è Failed to fetch chart data', 'warning');
                }
            } catch (error) {
                log(`‚ùå Chart refresh error: ${error.message}`, 'error');
            }
        }

        // Initialize charts on load
        initCharts();

        log('üöÄ Dashboard loaded successfully', 'success');
        log('Click buttons above to interact with EchoPilot APIs', 'info');
        log('üìä Use "‚ü≥ Refresh Charts" to update metrics visualization', 'info');
    </script>
</body>
</html>
