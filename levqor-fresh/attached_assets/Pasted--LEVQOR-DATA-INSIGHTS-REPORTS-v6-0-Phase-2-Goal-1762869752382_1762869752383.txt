# =========================================
# LEVQOR — DATA INSIGHTS + REPORTS (v6.0 Phase 2)
# Goal: publish anonymized insights + quarterly PDF report from existing telemetry
# Why: Thought-leadership + new data product; boosts trust and inbound
# Impact if ignored: Remain a tool vendor without authority; slower enterprise traction
# =========================================

# ---------- 0) PREREQS ----------
# Inputs already exist: Notion Pulse/Cost DBs, API Usage Log, Integrity Reports, Stripe revenue, Replit/Vercel costs
# Secrets: NOTION_TOKEN, NOTION_PULSE_DB_ID, NOTION_COST_DB_ID, NOTION_API_USAGE_DB_ID, DRIVE_SERVICE_ACCOUNT_JSON, REPORTS_DRIVE_FOLDER_ID

# ---------- 1) BACKEND MODULES ----------
mkdir -p modules/data_insights
cat > modules/data_insights/aggregator.py << 'PY'
import os, datetime as dt
from typing import Dict, Any, List
# Pseudocode utility imports for Notion/Stripe/DB
from utils.notion import query_db
from utils.stripe_analytics import get_revenue_summary
from utils.db import fetch_api_usage_agg, fetch_integrity_runs
def aggregate(period_days: int = 90) -> Dict[str, Any]:
    since = (dt.date.today() - dt.timedelta(days=period_days)).isoformat()
    kpis = {}
    # Core product signals
    kpis["revenue"] = get_revenue_summary(since=since)           # total, mrr, by product
    kpis["api_usage"] = fetch_api_usage_agg(since=since)         # calls, users, p95 latency (if stored)
    kpis["integrity_runs"] = fetch_integrity_runs(since=since)   # count, pass rate
    # Ops health (from Notion)
    pulse = query_db(os.environ["NOTION_PULSE_DB_ID"], since=since)
    cost  = query_db(os.environ["NOTION_COST_DB_ID"],  since=since)
    # Minimal transforms (examples)
    kpis["uptime_avg"] = round(sum([p.get("uptime",99.9) for p in pulse])/max(1,len(pulse)), 3)
    kpis["net_margin_est"] = (kpis["revenue"].get("total",0) - sum([c.get("Total Cost",0) for c in cost]))
    return kpis
PY

cat > modules/data_insights/report_builder.py << 'PY'
import io, datetime as dt
from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas

def build_pdf(kpis: dict) -> bytes:
    buf = io.BytesIO()
    c = canvas.Canvas(buf, pagesize=A4)
    w, h = A4
    y = h - 50
    def line(txt, step=18):
        nonlocal y
        c.drawString(40, y, txt); y -= step
    line(f"Levqor Insights Report — {dt.date.today().isoformat()}", 24)
    line("Executive Summary", 18)
    line(f"• Total revenue (period): ${kpis.get('revenue',{}).get('total',0):,.2f}")
    line(f"• Avg uptime: {kpis.get('uptime_avg',0)}%")
    line(f"• API calls (period): {kpis.get('api_usage',{}).get('calls',0):,}")
    line(f"• Integrity runs: {kpis.get('integrity_runs',{}).get('count',0):,}")
    line(f"• Net margin est.: ${kpis.get('net_margin_est',0):,.2f}")
    c.showPage(); c.save()
    return buf.getvalue()
PY

cat > modules/data_insights/uploader.py << 'PY'
import os, json, google.oauth2.service_account, googleapiclient.discovery
def upload_pdf(bytes_data: bytes, filename: str) -> str:
    creds = google.oauth2.service_account.Credentials.from_service_account_info(
        json.loads(os.environ["DRIVE_SERVICE_ACCOUNT_JSON"]),
        scopes=["https://www.googleapis.com/auth/drive"]
    )
    svc = googleapiclient.discovery.build("drive", "v3", credentials=creds)
    file_meta = {"name": filename, "parents": [os.environ["REPORTS_DRIVE_FOLDER_ID"]], "mimeType": "application/pdf"}
    media = googleapiclient.http.MediaInMemoryUpload(bytes_data, mimetype="application/pdf")
    f = svc.files().create(body=file_meta, media_body=media, fields="id, webViewLink, webContentLink").execute()
    # Make it link-accessible (viewer)
    svc.permissions().create(fileId=f["id"], body={"role":"reader","type":"anyone"}).execute()
    return f["webViewLink"]
PY

# ---------- 2) PUBLIC ROUTES ----------
mkdir -p api/routes/insights
cat > api/routes/insights/preview.py << 'PY'
from flask import Blueprint, jsonify
from modules.data_insights.aggregator import aggregate
bp = Blueprint('insights_preview', __name__)
@bp.route('/api/insights/preview', methods=['GET'])
def preview():
  return jsonify(aggregate(90))
PY

cat > api/routes/insights/report.py << 'PY'
import datetime as dt
from flask import Blueprint, jsonify
from modules.data_insights.aggregator import aggregate
from modules.data_insights.report_builder import build_pdf
from modules.data_insights.uploader import upload_pdf
bp = Blueprint('insights_report', __name__)
@bp.route('/api/insights/report', methods=['POST'])
def generate_report():
  kpis = aggregate(90)
  pdf = build_pdf(kpis)
  link = upload_pdf(pdf, f"Levqor_Insights_{dt.date.today().isoformat()}.pdf")
  return jsonify({"drive_link": link, "kpis": kpis})
PY

# Register blueprints in app factory/run.py.

# ---------- 3) FRONTEND PAGES ----------
mkdir -p levqor-site/src/app/insights
cat > levqor-site/src/app/insights/page.tsx << 'TSX'
'use client';
import { useEffect, useState } from 'react';
export default function Insights() {
  const [data,setData]=useState<any>(null);
  const [link,setLink]=useState<string>('');
  useEffect(()=>{ fetch('/api/insights/preview').then(r=>r.json()).then(setData); },[]);
  async function gen(){
    const r = await fetch('/api/insights/report', { method:'POST' });
    const j = await r.json(); setLink(j.drive_link); setData(j.kpis);
  }
  return (
    <div className="max-w-4xl mx-auto p-6 space-y-6">
      <h1 className="text-3xl font-bold">Levqor Insights</h1>
      {data && (
        <div className="grid md:grid-cols-2 gap-4">
          <Metric k="Revenue (period)" v={`$${(data.revenue?.total||0).toLocaleString()}`} />
          <Metric k="Avg Uptime" v={`${data.uptime_avg||0}%`} />
          <Metric k="API Calls" v={`${data.api_usage?.calls||0}`} />
          <Metric k="Integrity Runs" v={`${data.integrity_runs?.count||0}`} />
          <Metric k="Net Margin Est." v={`$${(data.net_margin_est||0).toLocaleString()}`} />
        </div>
      )}
      <button onClick={gen} className="border rounded-xl px-4 py-2">Generate Quarterly PDF</button>
      {link && <div className="text-sm">Report: <a className="underline" href={link} target="_blank">Open in Drive</a></div>}
    </div>
  );
}
function Metric({k,v}:{k:string;v:string}){ return (
  <div className="border rounded-2xl p-4"><div className="text-sm text-gray-500">{k}</div><div className="text-xl">{v}</div></div>
);}
TSX

# ---------- 4) FRONTEND API PROXIES ----------
mkdir -p levqor-site/src/app/api/insights/{preview,report}
cat > levqor-site/src/app/api/insights/preview/route.ts << 'TS'
import { NextResponse } from 'next/server';
export async function GET() {
  const api = process.env.NEXT_PUBLIC_API_BASE || 'https://api.levqor.ai';
  const r = await fetch(`${api}/api/insights/preview`, { cache: 'no-store' });
  const j = await r.json(); return NextResponse.json(j, { status: r.status });
}
TS

cat > levqor-site/src/app/api/insights/report/route.ts << 'TS'
import { NextResponse } from 'next/server';
export async function POST() {
  const api = process.env.NEXT_PUBLIC_API_BASE || 'https://api.levqor.ai';
  const r = await fetch(`${api}/api/insights/report`, { method:'POST' });
  const j = await r.json(); return NextResponse.json(j, { status: r.status });
}
TS

# ---------- 5) NOTION: PUBLIC EMBED (OPTIONAL) ----------
# Create a Notion page “Levqor Insights (Public)” and add an embed of the /insights page or Drive PDF links.

# ---------- 6) SCHEDULER JOB ----------
mkdir -p scripts/automation
cat > scripts/automation/insights_quarterly.py << 'PY'
import requests, datetime as dt, os
def run():
    api = os.environ.get("PUBLIC_API","https://api.levqor.ai")
    r = requests.post(f"{api}/api/insights/report", timeout=60)
    r.raise_for_status()
    print("Insights report generated", dt.datetime.utcnow().isoformat(), r.json().get("drive_link"))
if __name__ == "__main__": run()
PY
# Add APScheduler job: quarterly (BYMONTH=3,6,9,12) or monthly for now.

# ---------- 7) VALIDATION ----------
# Preview JSON:
curl -s https://api.levqor.ai/api/insights/preview | jq .
# Generate report:
curl -s -X POST https://api.levqor.ai/api/insights/report | jq .
# Frontend:
# Visit https://levqor.ai/insights → click "Generate Quarterly PDF" → Drive link appears
# Pulse includes new "Insights Reports Generated" counter (wire by incrementing in report route if desired)

# ---------- 8) SECURITY & PRIVACY ----------
# Ensure aggregator only uses anonymized/aggregated metrics; no PII fields.
# Gate /api/insights/report behind admin auth if needed; keep /preview public or semi-public.

# ---------- 9) ROLLBACK ----------
# Remove /api/insights/* routes and hide /insights nav item.
# Disable APScheduler job `insights_quarterly`.