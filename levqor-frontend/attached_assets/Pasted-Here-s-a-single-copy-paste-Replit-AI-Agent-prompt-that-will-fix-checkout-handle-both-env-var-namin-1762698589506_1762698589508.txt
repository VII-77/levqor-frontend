Here’s a single, copy-paste Replit AI Agent prompt that will fix checkout, handle both env-var naming schemes, redeploy, and verify.


---

AGENT PROMPT: Fix Stripe checkout end-to-end on levqor.ai

Goal Make POST https://levqor.ai/api/checkout return a Stripe Checkout URL for:

{"plan":"starter","term":"monthly"}

{"plan":"starter","term":"yearly"}

{"plan":"pro","term":"monthly"}

{"plan":"pro","term":"yearly"}


Remove the “Unknown plan/term” error. Keep webhooks intact.

Constraints

Codebase path: levqor-site/

Next.js App Router.

Vercel envs may be named either:

STRIPE_PRICE_ID_STARTER, STRIPE_PRICE_ID_PRO  (2 vars)

STRIPE_PRICE_STARTER, STRIPE_PRICE_STARTER_YEAR, STRIPE_PRICE_PRO, STRIPE_PRICE_PRO_YEAR  (4 vars)


SITE_URL exists and equals https://levqor.ai.

Do not introduce interactive steps. Commit and push so Vercel auto-deploys.

If Vercel CLI deploy is blocked by team permissions, rely on Git push only.


Steps

1. Detect available envs (non-interactive)

Read process.env keys at build time only with static references, not dynamic indexing.

Implement a helper that safely resolves a price id from the two naming schemes:

If 4-var scheme present, map:

starter+monthly → process.env.STRIPE_PRICE_STARTER

starter+yearly  → process.env.STRIPE_PRICE_STARTER_YEAR

pro+monthly     → process.env.STRIPE_PRICE_PRO

pro+yearly      → process.env.STRIPE_PRICE_PRO_YEAR


Else if 2-var scheme present, map:

starter+monthly → process.env.STRIPE_PRICE_ID_STARTER

pro+monthly     → process.env.STRIPE_PRICE_ID_PRO

For yearly in 2-var mode, return 400 with message yearly plan not configured.



Add minimal telemetry in logs: which scheme was chosen.



2. Update the API route

File: levqor-site/src/app/api/checkout/route.ts

Use Stripe SDK with current API version: { apiVersion: "2024-10-28" }.

Accept POST JSON body with plan and term. Validate values:

plan ∈ {"starter","pro"}

term ∈ {"monthly","yearly"}


If invalid or missing, return 400 { error: "Unknown plan/term" }.

Resolve priceId via helper. If missing, return 400 with clear message.

Create Checkout Session:

mode: "subscription", line_items: [{ price: priceId, quantity: 1 }]

success_url: ${process.env.SITE_URL}/success?session_id={CHECKOUT_SESSION_ID}

cancel_url: ${process.env.SITE_URL}/pricing


Return 200 { url }.

Optionally support GET by reading plan and term from query and internally calling the same handler.



3. Keep webhooks

Leave levqor-site/src/app/api/stripe/webhook/route.ts as is.

Ensure it returns 200 on unknown events and 400 on signature failure.



4. Add a tiny runtime log guard

Log booleans for each referenced env at the top of checkout handler once per cold start, e.g.:

env: { STARTER: !!process.env.STRIPE_PRICE_STARTER, STARTER_YEAR: !!process.env.STRIPE_PRICE_STARTER_YEAR, PRO: !!process.env.STRIPE_PRICE_PRO, PRO_YEAR: !!process.env.STRIPE_PRICE_PRO_YEAR, ID_STARTER: !!process.env.STRIPE_PRICE_ID_STARTER, ID_PRO: !!process.env.STRIPE_PRICE_ID_PRO }




5. Tests (non-interactive, agent-run)

After code change, from repo root run:

curl -s -X POST https://levqor.ai/api/checkout \
  -H "content-type: application/json" \
  --data '{"plan":"starter","term":"monthly"}'

Expect JSON with "url":"https://checkout.stripe.com/...".

Also test:

curl -s -X POST https://levqor.ai/api/checkout \
  -H "content-type: application/json" \
  --data '{"plan":"pro","term":"yearly"}'

Expect URL when 4-var scheme exists; else 400 with yearly plan not configured.



6. Commit and deploy

From repo root:

git add levqor-site/src/app/api/checkout/route.ts
git commit -m "Fix Stripe checkout: support both env naming schemes, validate plan/term, return JSON url"
git push origin main

Do not rely on vercel deploy to avoid team permission issues.



7. Verify after deploy

Wait ~2 minutes, then:

curl -i https://levqor.ai/api/checkout | head -n 20

Expected HTTP/2 405 (POST only).

Run the two POST tests again and print bodies.

If any 400 persists, print the chosen scheme and present env-presence booleans from the runtime log to stdout to show what’s missing.




Acceptance criteria

POST /api/checkout returns a Stripe URL for all configured plan/term pairs.

No “Unknown plan/term” unless the envs truly don’t exist for that pair.

No dynamic process.env[key] indexing.

Changes committed and pushed. Live site passes the curl tests.



---

Use that as-is. It tells the agent exactly what to change, how to deploy, and how to verify.