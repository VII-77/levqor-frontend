Hereâ€™s a Replit AI Agent full prompt that executes the entire fix pipeline (backend verified, frontend auth + API protection repairs, redeploy, verify).
You can copy-paste it into the Replit â€œAgentâ€ chat directly.


---

ðŸ§  Replit AI Agent Prompt

You are operating inside the Replit workspace for `levqor-site` (frontend repo). 
Your goal: fix authentication and proxy routing so that:
- `/workflow` redirects to `/signin` when unauthenticated.
- `/api/workflows` returns 401 (not 403) when unauthenticated and proxies backend data correctly when logged in.

Follow this exact sequence and verify each step.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
STEP 1 â€” VERIFY CONTEXT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Confirm current directory is ~/workspace/levqor-site
   â†’ If not, `cd ~/workspace/levqor-site`
2. Show folder structure under `src/app/api` and `src/`
   â†’ Use `tree -L 3 src/app/api` or `find src/app/api -type f | sort`
   â†’ Confirm that `auth/[...nextauth]/route.ts` exists.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
STEP 2 â€” FIX FRONTEND AUTH + API ROUTES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Ensure the `middleware.ts` exists and correctly protects `/workflow`:
   ```bash
   cat > src/middleware.ts <<'TS'
   export { default } from "next-auth/middleware";
   export const config = { matcher: ["/workflow"] };
   TS

2. Recreate the /api/workflows route with the correct logic:

mkdir -p src/app/api/workflows
cat > src/app/api/workflows/route.ts <<'TS'
import { getServerSession } from "next-auth";
import { NextResponse } from "next/server";
import { authOptions } from "@/app/api/auth/[...nextauth]/route";

export async function GET() {
  const session = await getServerSession(authOptions);
  if (!session)
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  const res = await fetch("https://api.levqor.ai/api/intelligence/recommendations", { cache: "no-store" });
  const data = await res.json();
  return NextResponse.json({ items: data });
}
TS


3. Ensure all files use Node runtime for NextAuth compatibility:

grep -q "runtime" src/app/api/auth/[...nextauth]/route.ts || \
  sed -i '1i export const runtime = "nodejs";' src/app/api/auth/[...nextauth]/route.ts



â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ STEP 3 â€” COMMIT AND PUSH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

git add -A
git commit -m "fix(auth): enforce middleware + Node runtime + workflows API proxy"
git push origin main

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ STEP 4 â€” VERIFY DEPLOYMENT (after 90s) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Run these after build completes:

# Verify new build deployed
curl -sSI https://levqor.ai | grep -E "x-vercel-id|age:"

# Check unauthenticated API should now return 401
curl -sI https://levqor.ai/api/workflows | head -5

# Check /workflow should now redirect (307/308 â†’ /signin)
curl -sI https://levqor.ai/workflow | grep -Ei "HTTP|location"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ VERIFICATION CRITERIA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ âœ… /api/workflows â†’ HTTP/2 401 Unauthorized (unauthenticated)
âœ… /workflow â†’ 307 or 308 redirect to /signin
âœ… Build header (x-vercel-id) shows new deployment
âœ… No 403 HTML responses from Cloudflare

If any verification fails:

Print next.config.js (first 20 lines)

Print Vercel build log for /api/workflows function

Then reattempt build fix for Edge vs Node runtime.


â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ END OF TASK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

---

**Purpose:**  
This script systematically re-creates missing files, enforces Node runtime for NextAuth, protects `/workflow`, pushes to GitHub (triggering Vercel deploy), and validates both redirect + auth proxy behavior end-to-end.  

Once it finishes, you should see `/workflow` redirect to sign-in and `/api/workflows` respond with `401`.