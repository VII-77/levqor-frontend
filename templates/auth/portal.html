<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Portal - EchoPilot AI</title>
    <link rel="stylesheet" href="/static/brand.css">
    <script src="/static/dark-mode.js" defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen">
    <!-- Navigation -->
    <nav style="background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color);" class="sticky top-0 z-50">
        <div class="container">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold gradient-text">
                        ðŸ¤– EchoPilot
                    </h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="theme-toggle" class="btn btn-ghost btn-sm" aria-label="Toggle theme">ðŸŒ™</button>
                    <span id="userEmail" class="text-sm" style="color: var(--text-tertiary);"></span>
                    <button onclick="logout()" class="btn btn-ghost btn-sm" style="color: var(--brand-red);">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container py-8">
        <!-- Welcome Section -->
        <div class="mb-8">
            <h2 class="text-3xl font-bold mb-2">Welcome back!</h2>
            <p style="color: var(--text-tertiary);">Manage your account and view billing information</p>
        </div>

        <!-- Tabs -->
        <div style="border-bottom: 1px solid var(--border-color);" class="mb-6">
            <nav class="flex space-x-8">
                <button onclick="showTab('overview')" id="tab-overview" class="tab-button py-4 px-1 border-b-2" style="border-color: var(--brand-purple); color: var(--brand-purple); font-weight: 500;">
                    Overview
                </button>
                <button onclick="showTab('invoices')" id="tab-invoices" class="tab-button py-4 px-1 border-b-2 border-transparent" style="color: var(--text-tertiary);">
                    Invoices
                </button>
                <button onclick="showTab('support')" id="tab-support" class="tab-button py-4 px-1 border-b-2 border-transparent" style="color: var(--text-tertiary);">
                    Support
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div id="content-overview" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Account Info Card -->
                <div class="card">
                    <h3 class="card-header">Account Information</h3>
                    <div class="card-body">
                        <div class="space-y-3 text-sm">
                            <div>
                                <span style="color: var(--text-tertiary);">Email:</span>
                                <span id="accountEmail" class="ml-2"></span>
                            </div>
                            <div>
                                <span style="color: var(--text-tertiary);">Customer ID:</span>
                                <span id="customerId" class="ml-2 font-mono text-xs"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Billing Portal Card -->
                <div class="card">
                    <h3 class="card-header">Billing Management</h3>
                    <div class="card-body">
                        <p class="text-sm mb-4" style="color: var(--text-tertiary);">
                            Manage your subscription, payment methods, and view receipts in the Stripe Customer Portal.
                        </p>
                        <button
                            onclick="openBillingPortal()"
                            class="btn btn-primary"
                        >
                            Open Billing Portal
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-invoices" class="tab-content hidden">
            <div class="card">
                <div class="card-header">Billing History</div>
                <div id="invoicesList" class="card-body">
                    <div class="empty-state">
                        <div class="empty-state-description">Loading invoices...</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-support" class="tab-content hidden">
            <div class="card">
                <h3 class="card-header">Need Help?</h3>
                <div class="card-body">
                    <p class="mb-4" style="color: var(--text-tertiary);">
                        Our support team is here to help you with any questions or issues.
                    </p>
                    <div class="space-y-3">
                        <div>
                            <span style="color: var(--text-tertiary);">Email:</span>
                            <a href="mailto:support@echopilotai.replit.app" class="ml-2" style="color: var(--brand-purple);">
                                support@echopilotai.replit.app
                            </a>
                        </div>
                        <div>
                            <span style="color: var(--text-tertiary);">Documentation:</span>
                            <a href="/docs" class="ml-2" style="color: var(--brand-purple);">
                                View Documentation
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('jwt_token');
        
        if (!token) {
            window.location.href = '/auth/login';
        }

        // Load user profile
        async function loadProfile() {
            try {
                const response = await fetch('/api/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('userEmail').textContent = user.email;
                    document.getElementById('accountEmail').textContent = user.email;
                    document.getElementById('customerId').textContent = user.customer_id || 'N/A';
                } else {
                    logout();
                }
            } catch (error) {
                console.error('Failed to load profile:', error);
            }
        }

        // Load billing history
        async function loadInvoices() {
            try {
                const response = await fetch('/api/billing/history', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayInvoices(data.invoices || []);
                } else {
                    document.getElementById('invoicesList').innerHTML = '<div class="text-center text-gray-400 py-8">Unable to load invoices</div>';
                }
            } catch (error) {
                console.error('Failed to load invoices:', error);
            }
        }

        function displayInvoices(invoices) {
            const container = document.getElementById('invoicesList');
            
            if (invoices.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-8">No invoices found</div>';
                return;
            }

            container.innerHTML = invoices.map(inv => `
                <div class="flex items-center justify-between py-4 border-b border-gray-700 last:border-0">
                    <div>
                        <div class="font-medium">${inv.date}</div>
                        <div class="text-sm text-gray-400">${inv.description}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold">${inv.amount}</div>
                        <div class="text-sm ${inv.status === 'paid' ? 'text-green-400' : 'text-yellow-400'}">
                            ${inv.status}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function openBillingPortal() {
            try {
                const response = await fetch('/api/billing/portal', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    window.open(data.url, '_blank');
                } else {
                    alert('Unable to open billing portal');
                }
            } catch (error) {
                console.error('Failed to open billing portal:', error);
                alert('Connection error');
            }
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => {
                el.style.borderColor = 'transparent';
                el.style.color = 'var(--text-tertiary)';
            });

            // Show selected tab
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            const tabButton = document.getElementById(`tab-${tabName}`);
            tabButton.style.borderColor = 'var(--brand-purple)';
            tabButton.style.color = 'var(--brand-purple)';

            // Load data for tab
            if (tabName === 'invoices') {
                loadInvoices();
            }
        }

        function logout() {
            localStorage.removeItem('jwt_token');
            window.location.href = '/auth/login';
        }

        // Initialize
        loadProfile();
    </script>
</body>
</html>
